# ğŸš€ Remote Debug Workflow - SSH Tunnel Edition
# ===============================================
# This workflow creates a secure SSH tunnel for remote debugging sessions
#
# âœ¨ Features:
#   â€¢ ğŸ” Secure SSH access to build environments
#   â€¢ ğŸ› Pre-installed Go debugger (Delve)
#   â€¢ ğŸŒ Multi-platform support (Linux, macOS, Windows)
#   â€¢ ğŸ”„ Port forwarding for seamless debug sessions
#   â€¢ ğŸ³ Docker sidecar for enhanced compatibility
#   â€¢ ğŸ“ Persistent Go environment configuration

name: ğŸš§ Debug with SSH

on:
  workflow_dispatch:
    inputs:
      os:
        description: 'ğŸ–¥ï¸ Select your debugging platform'
        required: false
        type: choice
        options:
          - 'ğŸ§ Ubuntu LTS (amd64)'
          - 'ğŸ§ Ubuntu LTS (arm64)'
          - 'ğŸ macOS Latest (arm64)'
          - 'ğŸ macOS 13 (amd64)'
          - 'ğŸªŸ Windows Latest (amd64)'
          - 'ğŸªŸ Windows Latest (arm64)'

jobs:
  select-os:
    name: ğŸ—ºï¸ Platform Selection â†’ ${{ inputs.os }}
    runs-on: ubuntu-latest
    outputs:
      runner-os: ${{ steps.map-os.outputs.runner-os }}
      os-type: ${{ steps.map-os.outputs.os-type }}
      use-docker-sidecar: ${{ steps.map-os.outputs.use-docker-sidecar }}
      private-key: ${{ steps.generate-key.outputs.private-key }}
      public-key: ${{ steps.generate-key.outputs.public-key }}
    steps:
      - name: ğŸ¯ Map OS selection to runner
        id: map-os
        env:
          INPUT_OS: ${{ inputs.os }}
        run: |
          echo "ğŸ” Mapping OS selection: $INPUT_OS"
          case "$INPUT_OS" in
            *"Ubuntu LTS (amd64)"*)
              echo "âœ… Selected: Ubuntu Latest (AMD64)"
              echo "runner-os=ubuntu-latest" >> $GITHUB_OUTPUT
              echo "os-type=linux" >> $GITHUB_OUTPUT
              echo "use-docker-sidecar=false" >> $GITHUB_OUTPUT
              ;;
            *"Ubuntu LTS (arm64)"*)
              echo "âœ… Selected: Ubuntu 24.04 (ARM64)"
              echo "runner-os=ubuntu-24.04-arm" >> $GITHUB_OUTPUT
              echo "os-type=linux" >> $GITHUB_OUTPUT
              echo "use-docker-sidecar=false" >> $GITHUB_OUTPUT
              ;;
            *"macOS Latest (arm64)"*)
              echo "âœ… Selected: macOS Latest (ARM64)"
              echo "runner-os=macos-latest" >> $GITHUB_OUTPUT
              echo "os-type=macos" >> $GITHUB_OUTPUT
              echo "use-docker-sidecar=true" >> $GITHUB_OUTPUT
              ;;
            *"macOS 13 (amd64)"*)
              echo "âœ… Selected: macOS 13 (AMD64)"
              echo "runner-os=macos-13" >> $GITHUB_OUTPUT
              echo "os-type=macos" >> $GITHUB_OUTPUT
              echo "use-docker-sidecar=false" >> $GITHUB_OUTPUT
              ;;
            *"Windows Latest (amd64)"*)
              echo "âœ… Selected: Windows Latest (AMD64)"
              echo "runner-os=windows-latest" >> $GITHUB_OUTPUT
              echo "os-type=windows" >> $GITHUB_OUTPUT
              echo "use-docker-sidecar=false" >> $GITHUB_OUTPUT
              ;;
            *"Windows Latest (arm64)"*)
              echo "âœ… Selected: Windows 11 (ARM64)"
              echo "runner-os=windows-11-arm" >> $GITHUB_OUTPUT
              echo "os-type=windows" >> $GITHUB_OUTPUT
              echo "use-docker-sidecar=true" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "âš ï¸  No specific OS selected, defaulting to Ubuntu Latest"
              echo "runner-os=ubuntu-latest" >> $GITHUB_OUTPUT
              echo "os-type=linux" >> $GITHUB_OUTPUT
              echo "use-docker-sidecar=false" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: ğŸ”‘ Generate SSH Key Pair (ED25519)
        id: generate-key
        run: |
          echo "ğŸ” Generating secure SSH key pair..."
          ssh-keygen -t ed25519 -N "" -f ./id_ed25519
          
          echo "ğŸ“¤ Exporting private SSH key"
          {
            echo "private-key<<EOF"
            cat ./id_ed25519
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          
          echo "ğŸ“¤ Exporting public SSH key"
          echo "public-key=$(cat ./id_ed25519.pub)" >> $GITHUB_OUTPUT
          echo "âœ… SSH key pair generated successfully!"

  linux-sidecar:
    name: ğŸ³ Linux Docker Sidecar
    needs: [select-os]
    runs-on: ubuntu-latest
    if: needs.select-os.outputs.use-docker-sidecar == 'true'
    steps:
      - name: ğŸš€ Launch Linux Docker sidecar
        uses: lexbritvin/docker-sidecar-action/run-sidecar@main
        with:
          ssh-server-authorized-keys: ${{ needs.select-os.outputs.public-key }}
          use-bore: 'true'

      - name: â³ Wait for debug session to complete
        uses: lexbritvin/wait-action@v1
        with:
          condition-type: 'job'
          job-name: '/How to connect/'
          timeout-seconds: 3600
          poll-interval-seconds: 30

  debug-session:
    name: ğŸ‘‰ How to connect ğŸ‘ˆ
    needs: select-os
    runs-on: ${{ needs.select-os.outputs.runner-os || 'ubuntu-latest' }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ’» System Information
        uses: lexbritvin/os-info-action@v1

      - name: ğŸ¹ Set up Go environment
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: ğŸ› ï¸ Install debugging tools
        shell: bash
        run: |
          echo "ğŸ”§ Setting up debugging environment..."

          echo "ğŸ“ Configure Go temporary directory"
          export GOTMPDIR="$(pwd)/.gotmp"
          mkdir -p $GOTMPDIR
          echo "ğŸ“ Using temp directory: $GOTMPDIR"
          echo "GOTMPDIR=$GOTMPDIR" >> $GITHUB_ENV

          if [[ "${{ runner.os }}" == "macOS" ]]; then
            echo "ğŸ Configuring Go binary path for macOS..."
            ln -s $(which go) /usr/local/bin/go
            echo "âœ… Go binary linked to user path"
          fi
          
          # Check Windows ARM64 compatibility
          if [[ "${{ runner.os }}" == "Windows" && "${{ runner.arch }}" == "ARM64" ]]; then
            echo "âš ï¸ WARNING: Delve debugger is not available on Windows ARM64"
            echo "ğŸš« Remote debugging features will be limited on this platform"
          else
            echo "ğŸ“¦ Installing Delve debugger..."
            go install github.com/go-delve/delve/cmd/dlv@latest
            echo "âœ… Delve installed successfully!"
          fi
          
          echo "ğŸ“¦ Downloading Go modules..."
          go mod download
          go install github.com/gotesttools/gotestfmt/v2/cmd/gotestfmt@latest
          echo "âœ… Dependencies ready!"

      - name: ğŸ’¾ Save Go environment variables
        shell: bash
        run: |
          echo "ğŸ’¾ Persisting Go environment configuration..."
          echo "ğŸ“‹ Saving: GOTMPDIR=${GOTMPDIR}"
          
          case "$RUNNER_OS" in
            "Linux"|"macOS")
              echo "ğŸ§ğŸ Configuring Unix-like environment..."
              # Add Go environment variables to system profile
              echo "export GOTMPDIR=\"${GOTMPDIR}\"" | sudo tee -a /etc/profile
              echo "âœ… Environment saved to /etc/profile"
              echo "ğŸ’¡ To use: source /etc/profile"
              ;;
          
            "Windows")
              echo "ğŸªŸ Configuring Windows environment..."
              # ğŸ”§ Set system environment variables
              setx GOTMPDIR "${GOTMPDIR}" //M 2>/dev/null
              echo "âœ… Environment saved to Windows system variables"
              echo "ğŸ’¡ To use: Open new terminal session"
              ;;
          
            *)
              echo "âŒ Unsupported OS: $RUNNER_OS"
              exit 1
              ;;
          esac

      - name: ğŸ³ Install Local Docker
        uses: lexbritvin/setup-docker-action@main
        if: needs.select-os.outputs.use-docker-sidecar == 'false' && needs.select-os.outputs.os-type != 'linux'

      - name: ğŸ³ Set up Remote Docker
        id: docker-setup
        uses: lexbritvin/docker-sidecar-action/setup-remote-docker@main
        if: needs.select-os.outputs.use-docker-sidecar == 'true'
        with:
          private-key: ${{ needs.select-os.outputs.private-key }}
          use-remote-share: 'true'

      - name: ğŸ”— Establish SSH Debug Session
        id: ssh-session
        uses: lexbritvin/ssh-session-action@v1
        with:
          use-bore: 'true'
          use-actor-ssh-keys: 'true'
          detached: 'true'
          wait-timeout: '3600'

      - name: ğŸ‘‰ How to connect ğŸ‘ˆ
        env:
          HELP_MESSAGE: ${{ steps.ssh-session.outputs.help-message }}
          EXTRA_HELP: |
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                                        ğŸ› GO DEBUGGING WITH DELVE ğŸš€                            
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            \033[1;36mâ”Œâ”€ ğŸ”„ PORT FORWARDING SETUP\033[0m
            \033[1;36mâ”‚\033[0m   \033[1mFor Delve debugging, forward port 2345:\033[0m
            \033[1;36mâ”‚\033[0m   \033[1;33mssh -L 2345:localhost:2345 [...]\033[0m
            \033[1;36mâ””â”€\033[0m
            
            \033[1;32mâ”Œâ”€ ğŸ§ª TESTING COMMANDS\033[0m
            \033[1;32mâ”‚\033[0m   \033[1mâ€¢ Run all tests:\033[0m
            \033[1;32mâ”‚\033[0m     \033[1;96mgo test -v ./...\033[0m
            \033[1;32mâ”‚\033[0m   \033[1mâ€¢ Run specific test:\033[0m
            \033[1;32mâ”‚\033[0m     \033[1;96mgo test -v -run TestFunctionName ./...\033[0m
            \033[1;32mâ”‚\033[0m   \033[1mâ€¢ Run with coverage:\033[0m
            \033[1;32mâ”‚\033[0m     \033[1;96mgo test -v -cover ./...\033[0m
            \033[1;32mâ””â”€\033[0m
            
            \033[1;33mâ”Œâ”€ ğŸ› DEBUGGING COMMANDS\033[0m
            \033[1;33mâ”‚\033[0m   \033[1mâ€¢ Debug specific test:\033[0m
            \033[1;33mâ”‚\033[0m     \033[1;95mdlv --listen=:2345 --headless --api-version=2 test ./... -- -test.run TestName\033[0m
            \033[1;33mâ”‚\033[0m   \033[1mâ€¢ Debug main application:\033[0m
            \033[1;33mâ”‚\033[0m     \033[1;95mdlv debug --headless --listen=:2345 --api-version=2 ./cmd/main -- [args...]\033[0m
            \033[1;33mâ”‚\033[0m   \033[1mâ€¢ Attach to running process:\033[0m
            \033[1;33mâ”‚\033[0m     \033[1;95mdlv attach --headless --listen=:2345 --api-version=2 [PID]\033[0m
            \033[1;33mâ””â”€\033[0m
            
            \033[1;34mâ”Œâ”€ ğŸ”— IDE INTEGRATION\033[0m
            \033[1;34mâ”‚\033[0m   \033[1mâ€¢ GoLand/IntelliJ IDEA:\033[0m
            \033[1;34mâ”‚\033[0m     \033[1mâ†’ Run/Debug Configurations â†’ Go Remote\033[0m
            \033[1;34mâ”‚\033[0m     \033[1mâ†’ Host: localhost, Port: 2345\033[0m
            \033[1;34mâ”‚\033[0m   \033[1mâ€¢ VS Code:\033[0m
            \033[1;34mâ”‚\033[0m     \033[1mâ†’ Use 'Go: Connect to server' command\033[0m
            \033[1;34mâ”‚\033[0m     \033[1mâ†’ Configure launch.json with 'connect' mode\033[0m
            \033[1;34mâ””â”€\033[0m
            
            \033[1;35mâ”Œâ”€ ğŸ’¡ HELPFUL TIPS\033[0m
            \033[1;35mâ”‚\033[0m   \033[1mâ€¢ Set breakpoints before starting debug session\033[0m
            \033[1;35mâ”‚\033[0m   \033[1mâ€¢ Use 'dlv help' for more commands\033[0m
            \033[1;35mâ”‚\033[0m   \033[1mâ€¢ Check firewall settings if connection fails\033[0m
            \033[1;35mâ”‚\033[0m   \033[1mâ€¢ Session will auto-terminate after 30 minutes\033[0m
            \033[1;35mâ””â”€\033[0m
            
            \033[1;36mğŸ“š Resources:\033[0m
            \033[1mâ€¢ Delve Documentation: https://github.com/go-delve/delve/tree/master/Documentation\033[0m
            \033[1mâ€¢ GoLand Remote Debug: https://www.jetbrains.com/help/go/attach-to-running-go-processes-with-debugger.html\033[0m
            \033[1mâ€¢ VS Code Go Debug: https://github.com/golang/vscode-go/blob/master/docs/debugging.md\033[0m
        shell: bash
        run: |
          echo "ğŸ‰ SSH Debug Session Started Successfully!"
          
          # Display the SSH connection instructions with enhanced formatting
          printf "%b\n" "$HELP_MESSAGE"
          
          # Display the debugging guide with colors
          printf "%b\n" "$EXTRA_HELP"
          
          echo "ğŸ¯ Happy debugging! Your session is ready to use."
